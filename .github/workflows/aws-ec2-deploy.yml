name: Deploy to EC2 via SSH

on:
  push:
    branches: [master]
  

# Define environment variables used throughout the workflow
env:
  AWS_REGION: eu-north-1            # Example region
  EC2_HOST: ec2-13-51-196-197.eu-north-1.compute.amazonaws.com            # Replace with your EC2 Public IP or DNS
  EC2_USER: ubuntu                # Replace with the user for your AMI (e.g., 'ubuntu', 'ec2-user')
  TARGET_DIR: /home/ubuntu/    # The directory on EC2 where code will be deployed

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # --- SSH Setup ---
      # This step sets up the private key for secure SSH connection
      - name: Set up SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          # This secret must be stored in your GitHub repository's secrets
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
          
      # --- Deployment ---
      # Use rsync over SSH to copy the files to the EC2 instance
      - name: Deploy via rsync
        run: |
          # The -e "ssh -o StrictHostKeyChecking=no" option bypasses the host key check
          # The -a (archive) flag preserves permissions, timestamps, etc.
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            . \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.TARGET_DIR }}
            
      # --- Remote Commands (Post-Deployment) ---
      # Execute commands on the remote EC2 instance after files are copied
      - name: Run remote commands (Install, Restart Service, etc.)
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # The sequence of commands to run on the EC2 instance
          script: |
            echo "Deployment complete. Running post-deploy commands..."
            
            # Example: Navigate to the application directory
            cd ${{ env.TARGET_DIR }}
            
            # Example: Install dependencies for a Node.js app
            # npm install --production
            
            # Example: Restart a service using systemd
            # sudo systemctl restart my-web-service
            
            echo "Remote commands finished."