name: Deploy to EC2 via SSH

on:
  push:
    branches: [master]
  

env:
  AWS_REGION: eu-north-1            
  EC2_HOST: ec2-51-21-192-233.eu-north-1.compute.amazonaws.com
  EC2_USER: ubuntu                
  TARGET_DIR: /home/ubuntu/gear_share    

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        

      - name: Set up SSH Key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}
          

      - name: Deploy via rsync
        run: |
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            . \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.TARGET_DIR }}
            

      - name: Build and run the app
        uses: appleboy/ssh-action@v1.0.1
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Deployment complete. Running post-deploy commands..."

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            nvm use v24.12.0
            
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            
            cd ${{ env.TARGET_DIR }}/source/frontend
            
            npm ci
            
            echo "Building frontend..."
            npm run build
            
            echo "Restarting frontend with PM2..."
            pm2 stop frontend-prod 2>/dev/null || true
            pm2 delete frontend-prod 2>/dev/null || true
            pm2 start npm --name "frontend-prod" -- run preview
            pm2 save
            pm2 startup 2>/dev/null || true




            cd ${{ env.TARGET_DIR }}/source/backend

            ./mvnw spring-boot:stop
            ./mvnw clean package
            ./mvnw spring-boot:start

            echo "Deployment to EC2 finished successfully."




            if curl -s http://localhost:8080/health > /dev/null 2>&1; then
                echo "Backend is running successfully"
              else
                echo "Backend may have failed to start. Check backend.log for details."
                exit 1
              fi
              

              echo "Deployment to EC2 finished successfully."
              exit(0)